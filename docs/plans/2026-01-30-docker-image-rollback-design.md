# Docker Image Rollback Design

**Date:** 2026-01-30
**Status:** Draft

## Overview

Replace mutable `:latest` Docker image tags with immutable commit-SHA tags for reproducible deployments and easy rollback.

## Problem

Currently, `voipbin update` pulls `:latest` tags. This causes:
- No record of what version is running
- Impossible to rollback to previous version
- Different machines may pull different images at different times

## Solution

Use `docker-compose.override.yml` (gitignored) to pin images to commit-SHA tags while keeping `docker-compose.yml` clean with `:latest`.

## Design

### Update Flow

1. **Get list of VoIPBin images** from docker-compose.yml (filter only `voipbin/*`)

2. **Query Docker Hub API in parallel:**
   - Use `ThreadPoolExecutor` with 10 workers
   - For each image: get `latest` digest → find commit-SHA tag with matching digest

3. **Backup current override file** to `.voipbin-versions/YYYY-MM-DDTHH-MM-SS.yml`

4. **Generate new docker-compose.override.yml** with pinned tags

5. **Pull pinned images** and restart services

### Docker Hub API

```
GET https://hub.docker.com/v2/repositories/voipbin/{image}/tags/latest
→ { "digest": "sha256:abc123..." }

GET https://hub.docker.com/v2/repositories/voipbin/{image}/tags?page_size=100
→ Find tag with matching digest (not "latest")
```

No authentication required for public repos.

### File Structure

```
sandbox/
├── docker-compose.yml              # tracked (uses :latest)
├── docker-compose.override.yml     # gitignored (pinned tags)
└── .voipbin-versions/              # gitignored (rollback history)
    ├── 2026-01-28T10-30-00.yml
    ├── 2026-01-29T15-45-00.yml
    └── 2026-01-30T22-30-00.yml
```

### Override File Format

```yaml
# Auto-generated by voipbin CLI
# Generated: 2026-01-30T22:30:00Z
# Run 'voipbin update' to refresh
services:
  api-manager:
    image: voipbin/bin-api-manager:a1b2c3d
  call-manager:
    image: voipbin/bin-call-manager:a1b2c3d
  # ... all voipbin images
```

### History Retention

Keep last 100 versions. Delete older files on each update.

## CLI Commands

### New Commands

| Command | Description |
|---------|-------------|
| `version` | Show pinned image versions from override file |
| `version --json` | Output as JSON for scripting |

### Modified Commands

| Command | Behavior |
|---------|----------|
| `update` | Resolve tags → write override → pull pinned |
| `update --check` | Show current vs available (diff) |
| `rollback` | Interactive arrow-key selection |
| `rollback N` | Quick restore by number |
| `rollback --list` | Show numbered list without restoring |

### Command Output Examples

**version:**
```
voipbin> version

Image Versions (from docker-compose.override.yml)
==================================================
SERVICE                    TAG         UPDATED
api-manager                a1b2c3d     2026-01-30 22:30
call-manager               a1b2c3d     2026-01-30 22:30
customer-manager           a1b2c3d     2026-01-30 22:30
...

Override file: docker-compose.override.yml
Last updated:  2026-01-30 22:30:00
```

**rollback (interactive):**
```
voipbin> rollback
Select version to restore:
  > 2026-01-30 22:30  (current)
    2026-01-29 15:45
    2026-01-28 10:30
    2026-01-27 09:00

[↑/↓ to move, Enter to select, q to cancel]
```

**rollback --list:**
```
voipbin> rollback --list
  [1] 2026-01-30 22:30  (current)
  [2] 2026-01-29 15:45
  [3] 2026-01-28 10:30

voipbin> rollback 2
✓ Restored version from 2026-01-29 15:45
```

## Error Handling

### Docker Hub API Errors

| Scenario | Behavior |
|----------|----------|
| Network timeout | Retry 3 times with 2s backoff, then skip image with warning |
| Rate limited (429) | Wait and retry, show "Rate limited, waiting..." |
| Image not found | Skip with warning, continue other images |
| No commit-SHA tag found | Keep `:latest` for that image, warn user |

### File Errors

| Scenario | Behavior |
|----------|----------|
| No override file exists | `version` shows "No pins, using :latest" |
| Corrupted override file | Warn, offer to regenerate with `update` |
| No rollback history | `rollback` shows "No history available" |

### Warning Output Example

```
voipbin> update
Resolving image tags... [25/25]

Warnings:
  ! voipbin/bin-foo-manager: No commit-SHA tag found, keeping :latest
  ! voipbin/bin-bar-manager: API timeout after 3 retries

✓ Generated docker-compose.override.yml (23/25 images pinned)
```

## Git Ignore Additions

Add to `.gitignore`:
```
# Version pinning (local only)
docker-compose.override.yml
.voipbin-versions/
```

## Performance

- Sequential: ~25 images × 2 requests × 0.5s = ~25 seconds
- Parallel (10 workers): ~3-5 seconds
